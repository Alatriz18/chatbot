<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Mesa de Servicio TI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        /* Estilos temporales para forzar visibilidad */
        #notificationSystem {
            display: block !important;
            z-index: 9999 !important;
        }
        #notificationIcon {
            display: flex !important;
            background: #6366F1 !important;
        }
        
        /* Estilos para dropdown de usuarios */
        .user-select-dropdown {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .user-select-dropdown:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }
        
        .user-select-dropdown:hover {
            border-color: #9ca3af;
        }
        
        .user-cell {
            position: relative;
        }
        
        .user-edit-icon {
            margin-left: 5px;
            color: #6b7280;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .user-cell:hover .user-edit-icon {
            opacity: 1;
        }
        
        .save-user-btn {
            padding: 4px 8px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .cancel-user-btn {
            padding: 4px 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .user-edit-controls {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Auth Handler de Cognito - DEBE IR PRIMERO -->
    <script src="js/auth-handler.js"></script>
    
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-headset"></i> Mesa de Servicio</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Administrador</div>
                        <span class="user-role">Administrador</span>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="tickets.html" class="nav-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Tickets</span>
                </a>
                <a href="reportes.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Modo oscuro</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h2>Panel de Administración</h2>
                    <p>Gestiona y supervisa todos los tickets del sistema</p>
                </div>
                <div class="header-actions">
                    <a href="/chat" class="header-action-btn">
                        <i class="fas fa-comment-dots"></i>
                        <span>Ir al Chatbot</span>
                    </a>
                    <button class="header-action-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Actualizar</span>
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="stat-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="totalTickets">0</div>
                    <div class="stat-label">Tickets Totales</div>
                </div>

                <div class="stat-card pending">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span>5%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="pendingTickets">0</div>
                    <div class="stat-label">Tickets Pendientes</div>
                </div>

                <div class="stat-card finished">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span>8%</span>
                        </div>
                    </div>
                    <div class="stat-value" id="finishedTickets">0</div>
                    <div class="stat-label">Tickets Finalizados</div>
                </div>
            </div>

            <!-- Ticket Panel -->
            <div class="ticket-panel">
                <div class="panel-header">
                    <h3>Todos los Tickets</h3>
                    <div class="ticket-filters">
                        <button class="filter-btn active" data-filter="all">Todos</button>
                        <button class="filter-btn" data-filter="PE">Pendientes</button>
                        <button class="filter-btn" data-filter="FN">Finalizados</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="ticket-table">
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>Asunto</th>
                                <th>Usuario</th>
                                <th>Asignado a</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ticketList">
                            <!-- Tickets will be loaded here -->
                             <tr>
                    <td colspan="7" class="loading-tickets">
                        <i class="fas fa-spinner fa-spin"></i>
                        Cargando tickets...
                    </td>
                </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== SISTEMA DE NOTIFICACIONES ========== -->
    <div id="notificationSystem" class="notification-system">
        <div class="notification-icon" id="notificationIcon">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
        </div>
        
        <div class="notification-popup" id="notificationPopup">
            <div class="notification-header">
                <h4>Notificaciones</h4>
                <button class="clear-all" id="clearAllNotifications">Limpiar todo</button>
            </div>
            <div class="notification-list" id="notificationList">
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>No hay notificaciones</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TOAST NOTIFICATIONS ========== -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ========== MODAL CONFIGURACIÓN ========== -->
    <div id="notificationSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Configuración de Notificaciones</h3>
            <button class="modal-close" id="closeSettingsModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="setting-group">
                <label for="notificationSoundSelect">Sonido de notificación:</label>
                <select id="notificationSoundSelect" class="setting-select">
                    <option value="default">Sonido por defecto</option>
                    <option value="chime">Campana</option>
                    <option value="alert">Alerta</option>
                    <option value="message">Mensaje</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            
            <div id="customSoundSection" class="setting-group" style="display: none;">
                <label for="customSoundUpload">Subir sonido personalizado:</label>
                <input type="file" id="customSoundUpload" accept="audio/mp3,audio/wav,audio/ogg,audio/m4a" class="setting-file">
                <small>Formatos soportados: MP3, WAV, OGG, M4A (Máx. 2MB)</small>
                
                <div id="currentSoundInfo" class="sound-info" style="margin-top: 10px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Sonido actual: <span id="currentSoundName">Ninguno</span></span>
                        <button type="button" id="deleteCustomSound" class="btn-danger" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <label for="notificationVolume">Volumen: <span id="volumeValue">70%</span></label>
                <input type="range" id="notificationVolume" min="0" max="100" value="70" class="setting-range">
            </div>

            <div class="setting-group">
                <label class="setting-checkbox">
                    <input type="checkbox" id="autoMarkAsRead" checked>
                    <span class="checkmark"></span>
                    Marcar como leídas automáticamente al abrir
                </label>
            </div>

            <div class="setting-group">
                <label class="setting-checkbox">
                    <input type="checkbox" id="desktopNotifications" checked>
                    <span class="checkmark"></span>
                    Mostrar notificaciones del sistema
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="testNotificationSound">
                <i class="fas fa-volume-up"></i> Probar sonido
            </button>
            <button class="btn-primary" id="saveNotificationSettings">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

    <!-- ========== ARCHIVOS DE SONIDO ========== -->
    <audio id="defaultNotificationSound" preload="auto">
        <source src="static/notification-sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="chimeNotificationSound" preload="auto">
        <source src="static/chime-sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="alertNotificationSound" preload="auto">
        <source src="static/alert-sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="messageNotificationSound" preload="auto">
        <source src="static/message-sound.mp3" type="audio/mpeg">
    </audio>
    <audio id="customNotificationSound" preload="auto"></audio>

    <!-- ========== SCRIPTS ========== -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/admin.js"></script>
    <script>

        // Variables globales
let allUsers = [];
let allTickets = [];
let currentUser = null;

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    initializeAdminPanel();
});

async function initializeAdminPanel() {
    // Verificar autenticación con Cognito
    const userData = localStorage.getItem('user');
    if (!userData || !authHandler.isAuthenticated()) {
        authHandler.redirectToLogin();
        return;
    }
    
    currentUser = JSON.parse(userData);
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();

    // Cargar datos iniciales
    await loadAllUsers();
    await loadTickets();
    
    // Configurar event listeners
    setupEventListeners();
    setupWebSocket();
}

// Cargar todos los usuarios
async function loadAllUsers() {
    try {
        showLoading();
        const response = await fetch('/api/users');
        if (response.ok) {
            allUsers = await response.json();
            console.log('Usuarios cargados:', allUsers.length);
        } else {
            throw new Error('Error al cargar usuarios');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al cargar usuarios', 'error');
    } finally {
        hideLoading();
    }
}

// Cargar tickets
async function loadTickets() {
    try {
        showLoading();
        const response = await fetch('/api/admin/tickets');
        if (response.ok) {
            allTickets = await response.json();
            renderTickets(allTickets);
            updateStats(allTickets);
        } else {
            throw new Error('Error al cargar tickets');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al cargar tickets', 'error');
    } finally {
        hideLoading();
    }
}

// Renderizar tickets en la tabla
function renderTickets(tickets) {
    const ticketList = document.getElementById('ticketList');
    
    if (!tickets || tickets.length === 0) {
        ticketList.innerHTML = `
            <tr>
                <td colspan="7" class="no-tickets">
                    <i class="fas fa-inbox"></i>
                    <p>No hay tickets disponibles</p>
                </td>
            </tr>
        `;
        return;
    }

    let ticketsHTML = '';
    
    tickets.forEach(ticket => {
        const statusClass = ticket.ticket_est_ticket === 'FN' ? 'status-finished' : 'status-pending';
        const statusText = ticket.ticket_est_ticket === 'FN' ? 'Finalizado' : 'Pendiente';
        const date = new Date(ticket.ticket_fec_ticket).toLocaleDateString('es-ES');
        
        // Generar opciones para el dropdown de usuarios
        const userOptions = allUsers.map(user => 
            `<option value="${user.username}" ${user.username === ticket.ticket_tusua_ticket ? 'selected' : ''}>
                ${user.username}
            </option>`
        ).join('');
        
        ticketsHTML += `
            <tr data-ticket-id="${ticket.ticket_id_ticket}">
                <td class="ticket-id">${ticket.ticket_id_ticket}</td>
                <td class="ticket-subject">${ticket.ticket_asu_ticket}</td>
                <td class="user-cell">
                    <div class="user-display">
                        <span class="username-text">${ticket.ticket_tusua_ticket || 'Sin usuario'}</span>
                        <i class="fas fa-edit user-edit-icon" data-ticket-id="${ticket.ticket_id_ticket}"></i>
                    </div>
                    <div class="user-edit-controls">
                        <select class="user-select-dropdown" id="userSelect_${ticket.ticket_id_ticket}">
                            <option value="">Seleccionar usuario...</option>
                            ${userOptions}
                        </select>
                        <div class="edit-buttons">
                            <button class="save-user-btn" data-ticket-id="${ticket.ticket_id_ticket}" title="Guardar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="cancel-user-btn" data-ticket-id="${ticket.ticket_id_ticket}" title="Cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </td>
                <td class="assigned-to">
                    ${ticket.ticket_asignado_a || 'No asignado'}
                </td>
                <td>
                    <span class="ticket-status ${statusClass}">${statusText}</span>
                </td>
                <td class="ticket-date">${date}</td>
                <td class="ticket-actions">
                    <button class="btn-icon view-ticket" data-ticket-id="${ticket.ticket_id_ticket}" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon assign-ticket" data-ticket-id="${ticket.ticket_id_ticket}" title="Asignar técnico">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    ${ticket.ticket_est_ticket !== 'FN' ? `
                    <button class="btn-icon finish-ticket" data-ticket-id="${ticket.ticket_id_ticket}" title="Marcar como finalizado">
                        <i class="fas fa-check-circle"></i>
                    </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });
    
    ticketList.innerHTML = ticketsHTML;
    
    // Agregar event listeners para la edición de usuarios
    addUserEditEventListeners();
}

// Agregar event listeners para edición de usuarios
function addUserEditEventListeners() {
    // Iconos de edición
    document.querySelectorAll('.user-edit-icon').forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.stopPropagation();
            const ticketId = this.dataset.ticketId;
            enableUserEditing(ticketId);
        });
    });
    
    // Botones de guardar
    document.querySelectorAll('.save-user-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const ticketId = this.dataset.ticketId;
            saveUserChange(ticketId);
        });
    });
    
    // Botones de cancelar
    document.querySelectorAll('.cancel-user-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const ticketId = this.dataset.ticketId;
            disableUserEditing(ticketId);
        });
    });
    
    // Enter en dropdown
    document.querySelectorAll('.user-select-dropdown').forEach(select => {
        select.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const ticketId = this.id.replace('userSelect_', '');
                saveUserChange(ticketId);
            }
        });
    });
}

// Habilitar edición de usuario
function enableUserEditing(ticketId) {
    const row = document.querySelector(`tr[data-ticket-id="${ticketId}"]`);
    const userCell = row.querySelector('.user-cell');
    
    userCell.classList.add('editing');
    
    // Enfocar el dropdown
    const dropdown = row.querySelector('.user-select-dropdown');
    setTimeout(() => dropdown.focus(), 100);
}

// Deshabilitar edición de usuario
function disableUserEditing(ticketId) {
    const row = document.querySelector(`tr[data-ticket-id="${ticketId}"]`);
    const userCell = row.querySelector('.user-cell');
    
    userCell.classList.remove('editing');
}

// Guardar cambio de usuario
async function saveUserChange(ticketId) {
    const row = document.querySelector(`tr[data-ticket-id="${ticketId}"]`);
    const dropdown = row.querySelector('.user-select-dropdown');
    const newUsername = dropdown.value;
    
    if (!newUsername) {
        showToast('Por favor selecciona un usuario', 'error');
        dropdown.focus();
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/tickets/${ticketId}/reassign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: newUsername
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(result.message, 'success');
            
            // Actualizar la visualización
            const displaySpan = row.querySelector('.username-text');
            displaySpan.textContent = newUsername;
            
            disableUserEditing(ticketId);
            
            // Actualizar el ticket en los datos locales
            const ticketIndex = allTickets.findIndex(t => t.ticket_id_ticket === ticketId);
            if (ticketIndex !== -1) {
                allTickets[ticketIndex].ticket_tusua_ticket = newUsername;
            }
            
        } else {
            const error = await response.json();
            showToast(`Error: ${error.error}`, 'error');
        }
    } catch (error) {
        console.error('Error al reasignar usuario:', error);
        showToast('Error al reasignar usuario', 'error');
    }
}

// Configurar event listeners
function setupEventListeners() {
    // Botón de actualizar
    document.getElementById('refreshBtn').addEventListener('click', loadTickets);
    
    // Filtros de tickets
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            filterTickets(filter);
            updateActiveFilter(this);
        });
    });
}

// Filtrar tickets
function filterTickets(filter) {
    let filteredTickets = allTickets;
    
    if (filter !== 'all') {
        filteredTickets = allTickets.filter(ticket => ticket.ticket_est_ticket === filter);
    }
    
    renderTickets(filteredTickets);
}

// Actualizar filtro activo
function updateActiveFilter(activeBtn) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
}

// Actualizar estadísticas
function updateStats(tickets) {
    const total = tickets.length;
    const pending = tickets.filter(t => t.ticket_est_ticket === 'PE').length;
    const finished = tickets.filter(t => t.ticket_est_ticket === 'FN').length;
    
    document.getElementById('totalTickets').textContent = total;
    document.getElementById('pendingTickets').textContent = pending;
    document.getElementById('finishedTickets').textContent = finished;
}

// Funciones de utilidad
function showLoading() {
    // Implementar lógica de loading si es necesario
}

function hideLoading() {
    // Implementar lógica de loading si es necesario
}

function showToast(message, type = 'info') {
    // Implementar tu sistema de toast notifications
    console.log(`${type.toUpperCase()}: ${message}`);
}

function setupWebSocket() {
    // Implementar WebSocket para notificaciones en tiempo real
}
    </script>
</body>
</html>